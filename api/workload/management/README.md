# 数据库备份功能说明

## 功能概述

本功能提供了一个完整的数据库备份解决方案，包括自动备份、手动备份、备份恢复和备份管理等功能。特别适合在进行数据库迁移等重要操作前进行数据保护。

## 使用方法

### 1. 自动备份（推荐）

在执行数据库迁移时自动进行备份：

```bash
python manage.py migrate_with_backup
```

可选参数：
- `--skip-backup`: 跳过备份直接执行迁移
  ```bash
  python manage.py migrate_with_backup --skip-backup
  ```

### 2. 手动操作

#### 创建备份
```bash
python api/backup_db.py backup
```

#### 查看备份列表
```bash
python api/backup_db.py list
```

#### 恢复备份
```bash
python api/backup_db.py restore db_backups/backup_YYYYMMDD_HHMMSS.sql
```

## 备份特性

### 备份内容
- 完整的数据库结构和数据
- 当前的迁移状态记录
- 备份时间戳和配置信息

### 安全特性
- 使用 `--single-transaction` 确保备份一致性
- 不锁表，避免影响生产环境
- 自动处理敏感信息（如数据库密码）
- 使用 `--no-tablespaces` 避免需要额外权限

### 备份管理
- 自动维护最近的10个备份
- 自动清理旧备份
- 每个备份都有对应的配置文件（.json）
- 备份文件使用时间戳命名，便于管理

## 备份存储

- 备份文件位置：`api/db_backups/`
- 备份文件格式：`backup_YYYYMMDD_HHMMSS.sql`
- 配置文件格式：`backup_YYYYMMDD_HHMMSS.sql.json`

## 最佳实践

1. **定期备份**
   - 在进行重要的数据库修改前手动创建备份
   - 使用 `migrate_with_backup` 替代普通的 `migrate`

2. **备份管理**
   - 定期检查备份的完整性
   - 重要的备份建议手动复制到其他位置保存
   - 注意检查备份所占用的磁盘空间

3. **恢复操作**
   - 恢复前先创建当前状态的备份
   - 恢复后检查数据的完整性
   - 必要时更新迁移记录

## 常见问题

1. **备份失败**
   - 检查数据库连接配置
   - 确保有足够的磁盘空间
   - 检查数据库用户权限

2. **恢复失败**
   - 确保目标数据库存在
   - 检查用户是否有足够权限
   - 验证备份文件的完整性

3. **Django设置问题**
   - 确保正确设置 `DJANGO_SETTINGS_MODULE`
   - 检查数据库配置是否正确

## 注意事项

1. 备份过程中尽量避免大量的数据写入操作
2. 定期验证备份的可用性
3. 重要数据建议保留多个备份点
4. 大型数据库备份可能需要较长时间，请耐心等待
5. 恢复操作会覆盖现有数据，请谨慎操作

## 技术支持

如遇到问题，请检查：
1. 数据库连接配置
2. 用户权限设置
3. 磁盘空间
4. 日志输出信息

## 更新历史

### v1.0.0 (2024-03-19)
- 初始版本
- 支持自动备份和手动备份
- 实现备份管理和恢复功能
- 添加用户交互和错误处理 